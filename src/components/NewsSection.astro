---
import { getCollection } from "astro:content";

interface Props {}

const news = (await getCollection("news")).toSorted((a, b) =>
  b.data.date.localeCompare(a.data.date),
);

function formatDate(dateStr: string): string {
  return dateStr.replace(/-/g, ".");
}
---

<section id="news" class="bg-canvas-alt px-4 py-20 md:py-32 lg:px-8">
  <div class="mx-auto max-w-7xl">
    <h2 class="text-heading-2 font-bold tracking-snug text-heading md:text-2xl">
      News
    </h2>
    <p class="mt-2 text-body-secondary">お知らせ</p>

    <ul class="mt-10 divide-y divide-subtle md:mt-14" role="list">
      {
        news.map((entry, index) => (
          <li>
            <button
              type="button"
              data-news-index={index}
              data-content={entry.data.content}
              class="group flex w-full cursor-pointer flex-col gap-1 py-4 text-left transition-colors hover:text-link-hover md:flex-row md:items-baseline md:gap-6 md:py-5"
            >
              <time
                datetime={entry.data.date}
                class="text-caption shrink-0 tracking-wide text-body-secondary transition-colors group-hover:text-link-hover md:w-32"
              >
                {formatDate(entry.data.date)}
              </time>
              <span class="text-body transition-colors group-hover:text-link-hover">
                {entry.data.title}
              </span>
            </button>
          </li>
        ))
      }
    </ul>
  </div>

  <dialog
    data-news-modal
    aria-label="お知らせ詳細"
    class="m-0 h-full max-h-dvh w-full max-w-full bg-transparent p-0"
  >
    <div class="flex h-full w-full items-center justify-center p-4 md:p-8">
      <button
        type="button"
        data-news-modal-backdrop
        class="fixed inset-0 cursor-default"
        aria-label="閉じる"
        tabindex="-1"></button>

      <div
        class="relative z-10 w-full max-w-2xl rounded-lg bg-elevated p-6 md:p-8"
      >
        <button
          type="button"
          data-news-modal-close
          aria-label="閉じる"
          class="absolute top-4 right-4 z-20 flex h-10 w-10 items-center justify-center rounded-full text-body transition-colors hover:text-link-hover"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18 18 6M6 6l12 12"></path>
          </svg>
        </button>

        <div class="pr-8">
          <h3
            class="text-heading-3 font-semibold text-heading md:text-xl"
            data-news-modal-title
          >
          </h3>
          <time
            class="text-caption mt-1 block tracking-wide text-body-secondary"
            data-news-modal-date
          >
          </time>
        </div>

        <div
          class="text-body-std mt-6 whitespace-pre-wrap text-body"
          data-news-modal-content
        >
        </div>
      </div>
    </div>
  </dialog>
</section>

<script>
  const modal = document.querySelector<HTMLDialogElement>("[data-news-modal]");
  const modalTitle = modal?.querySelector<HTMLElement>(
    "[data-news-modal-title]",
  );
  const modalDate = modal?.querySelector<HTMLElement>("[data-news-modal-date]");
  const modalContent = modal?.querySelector<HTMLElement>(
    "[data-news-modal-content]",
  );

  function formatDate(dateStr: string): string {
    return dateStr.replace(/-/g, ".");
  }

  function openModal(button: HTMLElement) {
    if (!modal || !modalTitle || !modalDate || !modalContent) return;

    const li = button.closest("li");
    if (!li) return;

    const title = button.querySelector("span")?.textContent ?? "";
    const time = button.querySelector("time");
    const date = time?.getAttribute("datetime") ?? "";
    const content = button.dataset.content ?? "";

    modalTitle.textContent = title;
    modalDate.textContent = formatDate(date);
    if (time) {
      (modalDate as HTMLTimeElement).dateTime = date;
    }
    modalContent.textContent = content;

    modal.showModal();
  }

  function closeModal() {
    if (!modal) return;
    modal.close();
  }

  document
    .querySelectorAll<HTMLElement>("[data-news-index]")
    .forEach((button) => {
      button.addEventListener("click", () => openModal(button));
    });

  modal
    ?.querySelector("[data-news-modal-close]")
    ?.addEventListener("click", closeModal);

  modal
    ?.querySelector("[data-news-modal-backdrop]")
    ?.addEventListener("click", closeModal);
</script>
