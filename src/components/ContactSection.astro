---
interface Props {}
---

<section id="contact" class="bg-canvas px-4 py-10 md:py-20 lg:px-8">
  <div class="mx-auto max-w-7xl">
    <h2 class="text-heading-2 font-bold tracking-snug text-heading md:text-2xl">
      Contact
    </h2>
    <p class="mt-2 text-body-secondary">お問い合わせ</p>

    <form class="mx-auto mt-10 max-w-2xl md:mt-14" novalidate>
      <div
        id="contact-result"
        class="mb-6 hidden rounded-lg border p-4"
        aria-live="assertive"
      >
        <p id="contact-result-message" class="text-body-std font-semibold"></p>
      </div>

      <div
        id="contact-error-summary"
        class="mb-6 hidden rounded-lg border border-error-border bg-overlay p-4"
        role="alert"
      >
        <p class="text-body-std font-semibold text-error-text">
          入力内容に <span id="contact-error-count">0</span> 件のエラーがあります
        </p>
      </div>

      <div class="flex flex-col gap-2">
        <label
          for="contact-name"
          class="text-body-std font-semibold tracking-wider text-body"
        >
          お名前
          <span aria-hidden="true" class="text-body-secondary">*</span>
          <span class="sr-only">（必須）</span>
        </label>
        <input
          type="text"
          id="contact-name"
          name="name"
          required
          autocomplete="name"
          aria-describedby="contact-name-error"
          class="rounded-lg border border-default bg-overlay px-4 py-3 text-body transition-colors placeholder:text-body-secondary focus:border-focus focus:ring-2 focus:ring-focus focus:outline-none"
          placeholder="山田 太郎"
        />
        <p
          id="contact-name-error"
          class="text-caption hidden text-error-text"
          aria-live="polite"
        >
        </p>
      </div>

      <div class="mt-6 flex flex-col gap-2">
        <label
          for="contact-email"
          class="text-body-std font-semibold tracking-wider text-body"
        >
          メールアドレス
          <span aria-hidden="true" class="text-body-secondary">*</span>
          <span class="sr-only">（必須）</span>
        </label>
        <input
          type="email"
          id="contact-email"
          name="email"
          required
          autocomplete="email"
          aria-describedby="contact-email-error"
          class="rounded-lg border border-default bg-overlay px-4 py-3 text-body transition-colors placeholder:text-body-secondary focus:border-focus focus:ring-2 focus:ring-focus focus:outline-none"
          placeholder="example@email.com"
        />
        <p
          id="contact-email-error"
          class="text-caption hidden text-error-text"
          aria-live="polite"
        >
        </p>
      </div>

      <div class="mt-6 flex flex-col gap-2">
        <label
          for="contact-subject"
          class="text-body-std font-semibold tracking-wider text-body"
        >
          件名
          <span aria-hidden="true" class="text-body-secondary">*</span>
          <span class="sr-only">（必須）</span>
        </label>
        <input
          type="text"
          id="contact-subject"
          name="subject"
          required
          aria-describedby="contact-subject-error"
          class="rounded-lg border border-default bg-overlay px-4 py-3 text-body transition-colors placeholder:text-body-secondary focus:border-focus focus:ring-2 focus:ring-focus focus:outline-none"
          placeholder="お問い合わせの件名"
        />
        <p
          id="contact-subject-error"
          class="text-caption hidden text-error-text"
          aria-live="polite"
        >
        </p>
      </div>

      <div class="mt-6 flex flex-col gap-2">
        <label
          for="contact-message"
          class="text-body-std font-semibold tracking-wider text-body"
        >
          メッセージ
          <span aria-hidden="true" class="text-body-secondary">*</span>
          <span class="sr-only">（必須）</span>
        </label>
        <textarea
          id="contact-message"
          name="message"
          required
          rows="6"
          aria-describedby="contact-message-error"
          class="resize-y rounded-lg border border-default bg-overlay px-4 py-3 text-body transition-colors placeholder:text-body-secondary focus:border-focus focus:ring-2 focus:ring-focus focus:outline-none"
          placeholder="お問い合わせ内容をご記入ください"></textarea>
        <p
          id="contact-message-error"
          class="text-caption hidden text-error-text"
          aria-live="polite"
        >
        </p>
      </div>

      <div class="absolute -left-[9999px]" aria-hidden="true">
        <label for="contact-website">Website</label>
        <input
          type="text"
          id="contact-website"
          name="website"
          tabindex="-1"
          autocomplete="off"
        />
      </div>

      <div class="mt-8">
        <button
          type="submit"
          class="w-full rounded-lg bg-interactive px-6 py-3 font-semibold text-abyss transition-colors hover:bg-interactive-hover focus:ring-2 focus:ring-focus focus:ring-offset-2 focus:ring-offset-canvas focus:outline-none md:w-auto"
        >
          送信する
        </button>
      </div>
    </form>
  </div>
</section>

<script>
  const GAS_URL = import.meta.env.PUBLIC_GAS_ENDPOINT;
  const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const COOLDOWN_MS = 10_000;
  let lastSubmitTime = 0;

  const FIELDS = [
    {
      id: "contact-name",
      validate(value: string): string {
        if (!value.trim()) return "お名前を入力してください";
        return "";
      },
    },
    {
      id: "contact-email",
      validate(value: string): string {
        if (!value.trim()) return "メールアドレスを入力してください";
        if (!EMAIL_REGEX.test(value.trim()))
          return "正しいメールアドレスの形式で入力してください";
        return "";
      },
    },
    {
      id: "contact-subject",
      validate(value: string): string {
        if (!value.trim()) return "件名を入力してください";
        return "";
      },
    },
    {
      id: "contact-message",
      validate(value: string): string {
        if (!value.trim()) return "メッセージを入力してください";
        return "";
      },
    },
  ];

  function showError(fieldId: string, message: string): void {
    const input = document.getElementById(fieldId);
    const errorEl = document.getElementById(`${fieldId}-error`);
    if (!input || !errorEl) return;

    input.classList.replace("border-default", "border-error-border");
    input.setAttribute("aria-invalid", "true");
    errorEl.textContent = message;
    errorEl.classList.remove("hidden");
  }

  function clearError(fieldId: string): void {
    const input = document.getElementById(fieldId);
    const errorEl = document.getElementById(`${fieldId}-error`);
    if (!input || !errorEl) return;

    input.classList.replace("border-error-border", "border-default");
    input.removeAttribute("aria-invalid");
    errorEl.textContent = "";
    errorEl.classList.add("hidden");
  }

  function validateField(field: (typeof FIELDS)[number]): boolean {
    const input = document.getElementById(field.id) as
      | HTMLInputElement
      | HTMLTextAreaElement
      | null;
    if (!input) return true;

    const message = field.validate(input.value);
    if (message) {
      showError(field.id, message);
      return false;
    }
    clearError(field.id);
    return true;
  }

  function showResult(type: "success" | "error", message: string): void {
    const resultEl = document.getElementById("contact-result");
    const messageEl = document.getElementById("contact-result-message");
    if (!resultEl || !messageEl) return;

    resultEl.classList.remove(
      "hidden",
      "border-primary",
      "bg-overlay",
      "text-primary-light",
      "border-error-border",
      "text-error-text",
    );

    if (type === "success") {
      resultEl.classList.add(
        "border-primary",
        "bg-overlay",
        "text-primary-light",
      );
    } else {
      resultEl.classList.add(
        "border-error-border",
        "bg-overlay",
        "text-error-text",
      );
    }

    messageEl.textContent = message;
    resultEl.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }

  function hideResult(): void {
    const resultEl = document.getElementById("contact-result");
    if (!resultEl) return;
    resultEl.classList.add("hidden");
  }

  function init(): void {
    const form = document.querySelector(
      "#contact form",
    ) as HTMLFormElement | null;
    if (!form) return;

    const submitButton = form.querySelector(
      'button[type="submit"]',
    ) as HTMLButtonElement | null;

    for (const field of FIELDS) {
      const input = document.getElementById(field.id);
      if (!input) continue;

      input.addEventListener("blur", () => {
        validateField(field);
      });
    }

    form.addEventListener("submit", async (event: Event) => {
      event.preventDefault();
      hideResult();

      let errorCount = 0;
      let firstErrorId = "";

      for (const field of FIELDS) {
        const valid = validateField(field);
        if (!valid) {
          errorCount++;
          if (!firstErrorId) firstErrorId = field.id;
        }
      }

      const summary = document.getElementById("contact-error-summary");
      const countEl = document.getElementById("contact-error-count");

      if (errorCount > 0) {
        if (summary && countEl) {
          countEl.textContent = String(errorCount);
          summary.classList.remove("hidden");
        }
        const firstErrorInput = document.getElementById(firstErrorId);
        if (firstErrorInput) firstErrorInput.focus();
      } else {
        if (summary) summary.classList.add("hidden");

        const now = Date.now();
        if (now - lastSubmitTime < COOLDOWN_MS) {
          showResult("error", "連続送信はできません。しばらくお待ちください。");
          return;
        }

        const honeypot = document.getElementById(
          "contact-website",
        ) as HTMLInputElement | null;
        if (honeypot && honeypot.value) {
          showResult(
            "success",
            "お問い合わせを送信しました。ありがとうございます。",
          );
          form.reset();
          return;
        }

        const data = {
          name: (
            document.getElementById("contact-name") as HTMLInputElement
          ).value.trim(),
          email: (
            document.getElementById("contact-email") as HTMLInputElement
          ).value.trim(),
          subject: (
            document.getElementById("contact-subject") as HTMLInputElement
          ).value.trim(),
          message: (
            document.getElementById("contact-message") as HTMLTextAreaElement
          ).value.trim(),
        };

        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "送信中...";
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30_000);

        try {
          const response = await fetch(GAS_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(data),
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          if (response.ok) {
            const result = await response.json();
            if (result.result === "success") {
              lastSubmitTime = Date.now();
              showResult(
                "success",
                "お問い合わせを送信しました。ありがとうございます。",
              );
              form.reset();
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = "送信する";
              }
            } else {
              showResult(
                "error",
                "送信に失敗しました。時間をおいて再度お試しください。",
              );
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = "送信する";
              }
            }
          } else {
            showResult(
              "error",
              "送信に失敗しました。時間をおいて再度お試しください。",
            );
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = "送信する";
            }
          }
        } catch {
          clearTimeout(timeoutId);
          showResult(
            "error",
            "通信エラーが発生しました。ネットワーク接続を確認して再度お試しください。",
          );
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = "送信する";
          }
        }
      }
    });
  }

  init();
</script>
