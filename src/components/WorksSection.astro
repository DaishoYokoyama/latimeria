---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import WorksModal from "./WorksModal.astro";

interface Props {}

const fitClassMap: Record<string, string> = {
  contain: "object-contain",
  cover: "object-cover",
};

const positionClassMap: Record<string, string> = {
  top: "object-top",
  center: "object-center",
  bottom: "object-bottom",
  left: "object-left",
  right: "object-right",
  "left-top": "object-left-top",
  "left-bottom": "object-left-bottom",
  "right-top": "object-right-top",
  "right-bottom": "object-right-bottom",
};

const works = (await getCollection("works")).toSorted(
  (a, b) => a.data.order - b.data.order,
);
---

<section id="works" class="relative bg-canvas-alt">
  <div
    class="inset-x-0 top-0 z-10 bg-linear-to-b from-abyss/80 to-transparent pt-10 pb-4 md:pt-20"
  >
    <div class="mx-auto max-w-7xl px-4 lg:px-8">
      <h2
        class="text-heading-2 font-bold tracking-snug text-heading md:text-2xl"
      >
        Works
      </h2>
      <p class="mt-2 text-body-secondary">制作実績</p>
    </div>
  </div>

  <div class="swiper aspect-video" data-works-swiper>
    <div class="swiper-wrapper">
      {
        works.map((entry) => (
          <div
            class="swiper-slide relative cursor-pointer bg-abyss"
            role="button"
            tabindex="0"
            aria-label={`${entry.data.title} を拡大表示`}
            data-works-slide
            data-title={entry.data.title}
            data-description={entry.data.description}
          >
            <Image
              src={entry.data.image}
              alt={`${entry.data.title} の作例画像`}
              class={`h-full w-full ${fitClassMap[entry.data.imageFit]} ${positionClassMap[entry.data.imagePosition]}`}
              loading="lazy"
              data-works-slide-image
            />
            <div class="absolute inset-x-0 bottom-0 z-10 bg-linear-to-t from-abyss/90 via-abyss/50 to-transparent px-4 pt-20 pb-8 md:px-8 md:pb-12 lg:px-16">
              <div class="mx-auto max-w-7xl">
                <h3 class="text-heading-3 font-semibold text-heading md:text-xl">
                  {entry.data.title}
                </h3>
                <p class="text-body-std md:text-body-large text-body-secondary">
                  {entry.data.description}
                </p>
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <div class="swiper-pagination" data-works-pagination></div>
  </div>

  <WorksModal />
</section>

<script>
  import Swiper from "swiper";
  import { Autoplay, EffectFade, Pagination } from "swiper/modules";

  const swiperEl = document.querySelector<HTMLElement>("[data-works-swiper]");

  let swiperInstance: Swiper | null = null;

  if (swiperEl) {
    swiperInstance = new Swiper(swiperEl, {
      modules: [Autoplay, EffectFade, Pagination],
      effect: "fade",
      fadeEffect: {
        crossFade: true,
      },
      autoplay: {
        delay: 4000,
        disableOnInteraction: false,
        pauseOnMouseEnter: true,
      },
      loop: true,
      speed: 1000,
      pagination: {
        el: "[data-works-pagination]",
        clickable: true,
      },
    });
  }

  const modal = document.querySelector<HTMLDialogElement>("[data-works-modal]");
  const modalImage = modal?.querySelector<HTMLImageElement>(
    "[data-works-modal-image]",
  );
  const modalTitle = modal?.querySelector<HTMLElement>(
    "[data-works-modal-title]",
  );
  const modalDescription = modal?.querySelector<HTMLElement>(
    "[data-works-modal-description]",
  );

  function openModal(slide: HTMLElement) {
    if (!modal || !modalImage || !modalTitle || !modalDescription) return;

    const img = slide.querySelector<HTMLImageElement>(
      "[data-works-slide-image]",
    );
    if (!img) return;

    modalImage.src = img.currentSrc || img.src;
    modalImage.alt = img.alt;
    modalTitle.textContent = slide.dataset.title ?? "";
    modalDescription.textContent = slide.dataset.description ?? "";

    swiperInstance?.autoplay.stop();
    modal.showModal();
  }

  function closeModal() {
    if (!modal) return;
    modal.close();
    swiperInstance?.autoplay.start();
  }

  document
    .querySelectorAll<HTMLElement>("[data-works-slide]")
    .forEach((slide) => {
      slide.addEventListener("click", () => openModal(slide));
      slide.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openModal(slide);
        }
      });
    });

  modal
    ?.querySelector("[data-works-modal-close]")
    ?.addEventListener("click", closeModal);

  modal
    ?.querySelector("[data-works-modal-backdrop]")
    ?.addEventListener("click", closeModal);

  modal?.addEventListener("close", () => {
    swiperInstance?.autoplay.start();
  });
</script>
